<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tutorial - Moon Manual</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="tutorial.html" class="active"><strong aria-hidden="true">1.</strong> Tutorial</a></li><li class="chapter-item expanded "><a href="json_schema.html"><strong aria-hidden="true">2.</strong> JSON Schema</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Moon Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="moonbits-build-system-tutorial"><a class="header" href="#moonbits-build-system-tutorial">MoonBit's Build System Tutorial</a></h1>
<p>Moon is the build system for the MoonBit language, currently based on the <a href="https://github.com/evmar/n2">n2</a> project. Moon supports parallel and incremental builds. Additionally, moon also supports managing and building third-party packages on <a href="https://mooncakes.io/">mooncakes.io</a></p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before you begin with this tutorial, make sure you have installed the following:</p>
<ol>
<li>
<p><strong>MoonBit CLI Tools</strong>: Download it from the <a href="https://www.moonbitlang.com/download/">https://www.moonbitlang.com/download/</a>. This command line tool is needed for creating and managing MoonBit projects.</p>
<p>Use <code>moon help</code> to view the usage instructions.</p>
<pre><code class="language-bash">$ moon help
The build system and package manager for MoonBit.

Usage: moon [OPTIONS] &lt;COMMAND&gt;

Commands:
new                    Create a new moonbit package
build                  Build the current package
check                  Check the current package, but don't build object files
run                    Run WebAssembly module
test                   Test the current package
clean                  Clean the target directory
fmt                    Format moonbit source code
doc                    Generate documentation
info                   Generate public interface (`.mbti`) files for all packages in the module
add                    Add a dependency
remove                 Remove a dependency
install                Install dependencies
tree                   Display the dependency tree
login                  Log in to your account
register               Register an account at mooncakes.io
publish                Publish the current package
update                 Update the package registry index
coverage               Code coverage utilities
generate-build-matrix  Generate build matrix for benchmarking (legacy feature)
upgrade                Upgrade toolchains
shell-completion       Generate shell completion for bash/elvish/fish/pwsh/zsh to stdout
version                Print version info and exit
help                   Print this message or the help of the given subcommand(s)

Options:
-C, --directory &lt;SOURCE_DIR&gt;   The source code directory. Defaults to the current directory
    --target-dir &lt;TARGET_DIR&gt;  The target directory. Defaults to `source_dir/target`
-q, --quiet                    Suppress output
-v, --verbose                  Increase verbosity
    --trace                    Trace the execution of the program
    --dry-run                  Do not actually run the command
-h, --help                     Print help
</code></pre>
</li>
<li>
<p><strong>MoonBit Language</strong> plugin in Visual Studio Code: You can install it from the VS Code marketplace. This plugin provides a rich development environment for MoonBit, including functionalities like syntax highlighting, code completion, and more.</p>
</li>
</ol>
<p>Once you have these prerequisites fulfilled, let's start by creating a new MoonBit module.</p>
<h2 id="creating-a-new-module"><a class="header" href="#creating-a-new-module">Creating a New Module</a></h2>
<p>To create a new module, enter the <code>moon new</code> command in the terminal, and you will see the module creation wizard. By using all the default values, you can create a new module named <code>username/hello</code> in the <code>my-project</code> directory.</p>
<pre><code class="language-bash">$ moon new
Enter the path to create the project (. for current directory): my-project
Select the create mode: exec
Enter your username: username
Enter your project name: hello
Enter your license: Apache-2.0
Created my-project
</code></pre>
<blockquote>
<p>If you want use all default values, you can use <code>moon new my-project</code> to create a new module named <code>username/hello</code> in the <code>my-project</code> directory.</p>
</blockquote>
<h2 id="understanding-the-module-directory-structure"><a class="header" href="#understanding-the-module-directory-structure">Understanding the Module Directory Structure</a></h2>
<p>After creating the new module, your directory structure should resemble the following:</p>
<pre><code class="language-bash">my-project
├── LICENSE
├── README.md
├── moon.mod.json
└── src
    ├── lib
    │   ├── hello.mbt
    │   ├── hello_test.mbt
    │   └── moon.pkg.json
    └── main
        ├── main.mbt
        └── moon.pkg.json
</code></pre>
<p>Here's a brief explanation of the directory structure:</p>
<ul>
<li>
<p><code>moon.mod.json</code> is used to identify a directory as a MoonBit module. It contains the module's metadata, such as the module name, version, etc. <code>source</code> specifies the source directory of the module. The default value is <code>src</code>.</p>
<pre><code class="language-json">{
  "name": "username/hello",
  "version": "0.1.0",
  "readme": "README.md",
  "repository": "",
  "license": "Apache-2.0",
  "keywords": [],
  "description": "",
  "source": "src"
}
</code></pre>
</li>
<li>
<p><code>lib</code> and <code>main</code> directories: These are the packages within the module. Each package can contain multiple <code>.mbt</code> files, which are the source code files for the MoonBit language. However, regardless of how many <code>.mbt</code> files a package has, they all share a common <code>moon.pkg.json</code> file. <code>lib/*_test.mbt</code> are separate test files in the <code>lib</code> package, these files are for blackbox test, so private members of the <code>lib</code> package cannot be accessed directly.</p>
</li>
<li>
<p><code>moon.pkg.json</code> is package descriptor. It defines the properties of the package, such as whether it is the main package and the packages it imports.</p>
<ul>
<li>
<p><code>main/moon.pkg.json</code>:</p>
<pre><code class="language-json">{
  "is_main": true,
  "import": [
    "username/hello/lib"
  ]
}
</code></pre>
</li>
</ul>
<p>Here, <code>"is_main: true"</code> declares that the package needs to be linked by the build system into a wasm file.</p>
<ul>
<li>
<p><code>lib/moon.pkg.json</code>:</p>
<pre><code class="language-json">{}
</code></pre>
</li>
</ul>
<p>This file is empty. Its purpose is simply to inform the build system that this folder is a package.</p>
</li>
</ul>
<h2 id="working-with-packages"><a class="header" href="#working-with-packages">Working with Packages</a></h2>
<p>Our <code>username/hello</code> module contains two packages: <code>username/hello/lib</code> and <code>username/hello/main</code>.</p>
<p>The <code>username/hello/lib</code> package contains <code>hello.mbt</code> and <code>hello_test.mbt</code> files:</p>
<p><code>hello.mbt</code></p>
<pre><code class="language-moonbit">pub fn hello() -&gt; String {
    "Hello, world!"
}
</code></pre>
<p><code>hello_test.mbt</code></p>
<pre><code class="language-moonbit">test "hello" {
  if @lib.hello() != "Hello, world!" {
    fail!("@lib.hello() != \"Hello, world!\"")
  }
}
</code></pre>
<p>The <code>username/hello/main</code> package contains a <code>main.mbt</code> file:</p>
<pre><code class="language-moonbit">fn main {
  println(@lib.hello())
}
</code></pre>
<p>To execute the program, specify the file system's path to the <code>username/hello/main</code> package in the <code>moon run</code> command:</p>
<pre><code class="language-bash">$ moon run ./src/main
Hello, world!
</code></pre>
<p>You can also omit <code>./</code></p>
<pre><code class="language-bash">$ moon run src/main
Hello, world!
</code></pre>
<p>You can test using the <code>moon test</code> command:</p>
<pre><code class="language-bash">$ moon test
Total tests: 1, passed: 1, failed: 0.
</code></pre>
<h2 id="package-importing"><a class="header" href="#package-importing">Package Importing</a></h2>
<p>In the MoonBit's build system, a module's name is used to reference its internal packages.
To import the <code>username/hello/lib</code> package in <code>src/main/main.mbt</code>, you need to specify it in <code>src/main/moon.pkg.json</code>:</p>
<pre><code class="language-json">{
  "is_main": true,
  "import": [
    "username/hello/lib"
  ]
}
</code></pre>
<p>Here, <code>username/hello/lib</code> specifies importing the <code>username/hello/lib</code> package from the <code>username/hello</code> module, so you can use <code>@lib.hello()</code> in <code>main/main.mbt</code>.</p>
<p>Note that the package name imported in <code>src/main/moon.pkg.json</code> is <code>username/hello/lib</code>, and <code>@lib</code> is used to refer to this package in <code>src/main/main.mbt</code>. The import here actually generates a default alias for the package name <code>username/hello/lib</code>. In the following sections, you will learn how to customize the alias for a package.</p>
<h2 id="creating-and-using-a-new-package"><a class="header" href="#creating-and-using-a-new-package">Creating and Using a New Package</a></h2>
<p>First, create a new directory named <code>fib</code> under <code>lib</code>:</p>
<pre><code class="language-bash">mkdir src/lib/fib
</code></pre>
<p>Now, you can create new files under <code>src/lib/fib</code>:</p>
<p><code>a.mbt</code>:</p>
<pre><code class="language-moonbit">pub fn fib(n : Int) -&gt; Int {
  match n {
    0 =&gt; 0
    1 =&gt; 1
    _ =&gt; fib(n - 1) + fib(n - 2)
  }
}
</code></pre>
<p><code>b.mbt</code>:</p>
<pre><code class="language-moonbit">pub fn fib2(num : Int) -&gt; Int {
  fn aux(n, acc1, acc2) {
    match n {
      0 =&gt; acc1
      1 =&gt; acc2
      _ =&gt; aux(n - 1, acc2, acc1 + acc2)
    }
  }

  aux(num, 0, 1)
}
</code></pre>
<p><code>moon.pkg.json</code>:</p>
<pre><code class="language-json">{}
</code></pre>
<p>After creating these files, your directory structure should look like this:</p>
<pre><code class="language-bash">my-project
├── LICENSE
├── README.md
├── moon.mod.json
└── src
    ├── lib
    │   ├── fib
    │   │   ├── a.mbt
    │   │   ├── b.mbt
    │   │   └── moon.pkg.json
    │   ├── hello.mbt
    │   ├── hello_test.mbt
    │   └── moon.pkg.json
    └── main
        ├── main.mbt
        └── moon.pkg.json
</code></pre>
<p>In the <code>src/main/moon.pkg.json</code> file, import the <code>username/hello/lib/fib</code> package and customize its alias to <code>my_awesome_fibonacci</code>:</p>
<pre><code class="language-json">{
  "is_main": true,
  "import": [
    "username/hello/lib",
    {
      "path": "username/hello/lib/fib",
      "alias": "my_awesome_fibonacci"
    }
  ]
}
</code></pre>
<p>This line imports the <code>fib</code> package, which is part of the <code>lib</code> package in the <code>hello</code> module. After doing this, you can use the <code>fib</code> package in <code>main/main.mbt</code>. Replace the file content of <code>main/main.mbt</code> to:</p>
<pre><code class="language-moonbit">fn main {
  let a = @my_awesome_fibonacci.fib(10)
  let b = @my_awesome_fibonacci.fib2(11)
  println("fib(10) = \{a}, fib(11) = \{b}")

  println(@lib.hello())
}
</code></pre>
<p>To execute your program, specify the path to the <code>main</code> package:</p>
<pre><code class="language-bash">$ moon run ./src/main
fib(10) = 55, fib(11) = 89
Hello, world!
</code></pre>
<h2 id="adding-tests"><a class="header" href="#adding-tests">Adding Tests</a></h2>
<p>Let's add some tests to verify our fib implementation. Add the following content in <code>src/lib/fib/a.mbt</code>:</p>
<p><code>src/lib/fib/a.mbt</code></p>
<pre><code class="language-moonbit">test {
  assert_eq!(fib(1), 1)
  assert_eq!(fib(2), 1)
  assert_eq!(fib(3), 2)
  assert_eq!(fib(4), 3)
  assert_eq!(fib(5), 5)
}
</code></pre>
<p>This code tests the first five terms of the Fibonacci sequence. <code>test { ... }</code> defines an inline test block. The code inside an inline test block is executed in test mode.</p>
<p>Inline test blocks are discarded in non-test compilation modes (<code>moon build</code> and <code>moon run</code>), so they won't cause the generated code size to bloat.</p>
<h2 id="stand-alone-test-files-for-blackbox-tests"><a class="header" href="#stand-alone-test-files-for-blackbox-tests">Stand-alone test files for blackbox tests</a></h2>
<p>Besides inline tests, MoonBit also supports stand-alone test files. Source files ending in <code>_test.mbt</code> are considered test files for blackbox tests. For example, inside the <code>src/lib/fib</code> directory, create a file named <code>fib_test.mbt</code> and paste the following code:</p>
<p><code>src/lib/fib/fib_test.mbt</code></p>
<pre><code class="language-moonbit">test {
  assert_eq!(@fib.fib(1), 1)
  assert_eq!(@fib.fib2(2), 1)
  assert_eq!(@fib.fib(3), 2)
  assert_eq!(@fib.fib2(4), 3)
  assert_eq!(@fib.fib(5), 5)
}
</code></pre>
<p>Notice that the test code uses <code>@fib</code> to refer to the <code>username/hello/lib/fib</code> package. The build system automatically creates a new package for blackbox tests by using the files that end with <code>_test.mbt</code>. This new package will import the current package automatically, allowing you to use <code>@lib</code> in the test code.</p>
<p>Finally, use the <code>moon test</code> command, which scans the entire project, identifies, and runs all inline tests as well as files ending with <code>_test.mbt</code>. If everything is normal, you will see:</p>
<pre><code class="language-bash">$ moon test
Total tests: 3, passed: 3, failed: 0.
$ moon test -v
test username/hello/lib/hello_test.mbt::hello ok
test username/hello/lib/fib/a.mbt::0 ok
test username/hello/lib/fib/fib_test.mbt::0 ok
Total tests: 3, passed: 3, failed: 0.
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next prefetch" href="json_schema.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next prefetch" href="json_schema.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
